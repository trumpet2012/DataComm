{% extends 'base.html' %}
{% load qr_tags staticfiles %}

{% block content %}

    <div class="mdl-card mdl-cell mdl-cell--12-col-phone mdl-cell--3-col-tablet mdl-cell--4-col-desktop mdl-shadow--2dp card">
        <div class="mdl-layout-title connection-title">Session Information</div>
        <div class="connection-info">
            <div class="qrcode-container">
                <div class="fa-qrcode">
                    {% qr_from_text connect_url %}
                </div>
                <input type="text" value="{{ connect_url }}" readonly/>
            </div>
        </div>
    </div>
    <div class="mdl-card mdl-cell mdl-cell--12-col-phone mdl-cell--5-col-tablet mdl-cell--8-col-desktop mdl-shadow--2dp card">

            <div class="device-listing">
                <form id="trace-form">
                    {% csrf_token %}
                    <div id="devices">

                    </div>
                    <button class="mdl-button mdl-button-js mdl-color--green-400 mdl-button--raised trace-button">
                        <i class="material-icons">device_hub</i>
                        Trace
                    </button>
                </form>
            </div>

    </div>
    <div class="mdl-card mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--6-col-desktop
            mdl-shadow--2dp card fade" id="trace-card">
        <div id="loading-trace" class="mdl-progress mdl-js-progress mdl-progress__indeterminate fade">
            <h4 id="loading-text">Performing trace <span style="font-size: 12px;">(this may take a few moments)</span></h4>
        </div>
        <div id="trace-results" class="fade">
        </div>
    </div>

    <div class="mdl-card mdl-cell mdl-cell--12-col-phone mdl-cell--12-col-tablet mdl-cell--6-col-desktop
            mdl-shadow--2dp card fade" id="map-card">
        <div id="map-results">
        </div>
    </div>

{% endblock %}

{% block scripts %}
    <script src="{% static 'js/devices.js' %}"></script>
    <script>
        var device_listing_div = $('#devices');
        var device_url = "{% url 'device_listing' %}";
        var session_key = "{{ session_key }}";
        var material_js_url = "{% static 'js/material.min.js' %}";
        var trace_card = $("#trace-card");
        var resultsDiv = $("#trace-results");
        var trace_loader = $("#loading-trace");
        var map_card = $("#map-card");
        var map;

        fetch_devices(device_url, session_key)
            .done(function(data){
                updateDeviceListing(data);
            })
            .error(function(data){
                $('#devices').find('li').removeClass('loading');
                loading_text.remove();
            });
        $('.refresh').on('click', function(){
            $('#devices').find('li').addClass('loading');
            var loading_text = $('<span>Loading...</span>');
            loading_text.css({
                width: '100%',
                height: '100%',
                position: 'absolute',
                'text-align': 'center',
                top: '50%',
                opacity: 1
            }).appendTo(device_listing_div);
            fetch_devices(device_url, session_key)
                .done(function(data){
                    updateDeviceListing(data);
                })
                .error(function(data){
                    $('#devices').find('li').removeClass('loading');
                    loading_text.remove();
                });
        });
        setInterval(function(){
            fetch_devices(device_url, session_key)
                .done(function (data) {
                    updateDeviceListing(data);
                })
                .error(function (data) {
                    $('#devices').find('li').removeClass('loading');
                    loading_text.remove();
                });
        }, 5000);


        var traceForm = $('form');
        var traceUrl = '{% url "trace" %}';
        traceForm.submit(function(event){

            var formData = traceForm.serializeArray();
            var formDict = {};
            $.each(formData, function(index, data){
                console.log(data);
                if (data.name in formDict){
                    if (formDict[data.name].constructor == Array){
                        formDict[data.name].append(data.value);
                    } else {
                        var oldResults = formDict[data.name];
                        formDict[data.name] = [oldResults, data.value];
                    }
                }else{
                    formDict[data.name] = data.value;
                }
            });
            console.log(formDict);

            resultsDiv.removeClass('fade-in');
            trace_card.addClass('fade-in');
            trace_loader.addClass('fade-in');

            perform_trace(traceUrl, formData).done(function(data, textStatus, jqXHR){
                resultsDiv.html(data);
                trace_loader.removeClass('fade-in');
                resultsDiv.addClass('fade-in');
                map_card.addClass('fade-in');

            });
            event.preventDefault();
        });

        function initMap() {
            var opt = {
                minZoom: 3,
                maxZoom: 14,
                center: new google.maps.LatLng(54.5260, -105.2551),
                zoom: 4};
            var mapDiv = document.getElementById('map-results');
            map = new google.maps.Map(mapDiv, opt);
        }

    function updateDeviceListing(data){
        data = $(data);
        var form_fields = traceForm.serializeArray();
        $.each(form_fields, function(index, field){
            if (field.name == "devices") {
                data.find('input[name="devices"][value="' + field.value + '"]').attr('checked', true);
            }
        });
        $("#devices").html(data);
        // Reapply the MDL stylings that were lost after the ajax call.
        componentHandler.upgradeDom();
    }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?callback=initMap" async defer></script>
{% endblock scripts %}